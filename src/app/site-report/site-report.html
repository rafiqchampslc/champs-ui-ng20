<div class="report-page container my-4">

    <!-- Toolbar / filters -->
    <div class="card shadow-sm mb-3 report-toolbar">
        <div class="card-body">
            <div class="d-flex flex-wrap align-items-end gap-3">

                <!-- Back button -->
      <button class="btn btn-sm btn-secondary" type="button" (click)="goBack()">
        â¬… Back to dashboard
      </button>


                <!-- Download Excel -->
                <div class="ms-auto">
                    <button class="btn btn-sm btn-success" type="button" (click)="downloadExcel()"
                        [disabled]="!pivotRows.length">
                        ðŸ“¥ Download Excel (site template)
                    </button>
                </div>
            </div>

            <!-- Metadata line -->
            <div class="report-metadata mt-3" *ngIf="pivotRows.length">
                <div>
                    <strong>Country:</strong> {{ countryName || 'â€”' }} &nbsp;|&nbsp;
                    <strong>Site:</strong> {{ siteName || selectedSiteId }} &nbsp;|&nbsp;
                    <strong>Years:</strong> {{ years[0] }} â€“ {{ years[years.length - 1] }}
                    <span *ngIf="lastUploadDate">
                        &nbsp;|&nbsp; <strong>Last upload:</strong> {{ formatUploadDate() }}
                    </span>
                </div>
            </div>

            <div *ngIf="error" class="alert alert-danger mt-2 mb-0">
                {{ error }}
            </div>
        </div>
    </div>

    <!-- Table card -->
    <div class="card shadow-sm" *ngIf="pivotRows.length">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-0">Site-wise Aggregated HDSS Report</h6>
                <small class="text-muted">
                    Indicator values by year (numbers are right-aligned for easier comparison)
                </small>
            </div>
        </div>

        <div class="card-body p-0">

            <div class="report-table-wrapper table-responsive">
                <table class="table table-striped table-sm table-bordered mb-0 report-table">
                    <thead class="table-light">
                        <tr>
                            <th class="sticky-col align-middle">
                                Indicator name
                            </th>
                            <th *ngFor="let y of years" class="text-end align-middle year-header">
                                {{ y }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let r of pivotRows; let i = index">
                            <!-- normal data row -->
                            <tr [class.row-alt]="i % 2 === 1">
                                <td class="sticky-col" [ngClass]="{
            'indent-level-1': isLightIndent(r.indicatorName),
            'indent-level-2': isDeepIndent(r.indicatorName)
          }">
                                    {{ r.indicatorName }}
                                </td>

                                <td *ngFor="let y of years" class="text-end">
                                    {{ r.values[y] != null
                                    ? (r.values[y] | number : '1.0-0')
                                    : '' }}
                                </td>
                            </tr>

                            <!-- spacer row after specific indicators -->
                            <tr *ngIf="needsSpacerRow(r.indicatorName)" class="empty-row">
                                <td [attr.colspan]="1 + years.length">&nbsp;</td>
                            </tr>
                        </ng-container>
                    </tbody>


                    <!-- <tbody>
                        <tr *ngFor="let r of pivotRows; let i = index" [class.row-alt]="i % 2 === 1">
                            <td class="sticky-col" [ngClass]="{
                                'indent-level-1': isLightIndent(r.indicatorName),
                                'indent-level-2': isDeepIndent(r.indicatorName)
                                }">
                                {{ r.indicatorName }}
                            </td>


                            <td *ngFor="let y of years" class="text-end">
                                {{ r.values[y] != null
                                ? (r.values[y] | number : '1.0-0')
                                : '' }}
                            </td>
                        </tr>
                    </tbody> -->
                </table>
            </div>

        </div>
    </div>

    <!-- Empty state -->
    <div *ngIf="!pivotRows.length && !loading && !error" class="text-muted text-center mt-5">
        Select a site and click <strong>Load report</strong> to see data.
    </div>

</div>


<!-- <div class="container my-4">

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h4 class="card-title mb-3">Site-wise Aggregated HDSS Report</h4>

      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Site</label>
          <select class="form-select"
                  [(ngModel)]="selectedSiteId"
                  (change)="onSiteChange()">
            <option *ngFor="let s of sites" [value]="s.siteId">
              {{ s.siteId }}
            </option>
          </select>
        </div>

        <div class="col-md-4">
          <button class="btn btn-primary"
                  type="button"
                  (click)="loadReport()"
                  [disabled]="!selectedSiteId || loading">
            <span *ngIf="!loading">Load report</span>
            <span *ngIf="loading">Loading...</span>
          </button>
        </div>

        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <button class="btn btn-success"
                  type="button"
                  (click)="downloadExcel()"
                  [disabled]="!pivotRows.length">
            ðŸ“¥ Download Excel (site template)
          </button>
        </div>
      </div>

      <div class="mt-3">
        <div *ngIf="countryName">
          <strong>Country:</strong> {{ countryName }} |
          <strong>Site:</strong> {{ siteName || selectedSiteId }}
          <span *ngIf="lastUploadDate">
            | <strong>Last upload:</strong> {{ formatUploadDate() }}
          </span>
        </div>
      </div>

      <div *ngIf="error" class="alert alert-danger mt-3">
        {{ error }}
      </div>
    </div>
  </div>


  <div class="card shadow-sm" *ngIf="pivotRows.length">
    <div class="card-body table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Indicator name</th>
            <th *ngFor="let y of years" class="text-end">
              {{ y }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of pivotRows">
            <td>{{ r.indicatorName }}</td>
            <td *ngFor="let y of years" class="text-end">
              {{ r.values[y] != null ? (r.values[y] | number : '1.0-0') : '' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div> -->